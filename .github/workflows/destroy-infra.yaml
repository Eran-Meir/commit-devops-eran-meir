name: 4. üî¥ Destroy Infrastructure

on:
  workflow_dispatch:

env:
  TF_VERSION: 1.5.7

jobs:
  # 1. DESTROY CONSUMER FIRST (Remove the Bridge)
  destroy-consumer:
    name: Destroy Consumer
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Destroy (Consumer)
        working-directory: ./terraform/consumer
        run: |
          terraform init
          terraform destroy -auto-approve

  # 2. DESTROY PRODUCER SECOND (Remove the App)
  destroy-producer:
    name: Destroy Producer
    needs: destroy-consumer
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Destroy (Producer)
        working-directory: ./terraform/producer
        run: |
          terraform init
          terraform destroy -auto-approve
      - name: üîç Verify Empty Project (Zero Billing Check)
        if: always() # Ensures this runs even if the destroy had a minor error
        run: |
          echo "========================================"
          echo "          STARTING BILLING CHECK        "
          echo "========================================"
          
          echo "--- 1. Checking for Active GKE Clusters ---"
          gcloud container clusters list --project=commit-gcp-psc-eran-meir
          
          echo "--- 2. Checking for Active VMs ---"
          gcloud compute instances list --project=commit-gcp-psc-eran-meir
          
          echo "--- 3. Checking for Active Load Balancers (Forwarding Rules) ---"
          gcloud compute forwarding-rules list --project=commit-gcp-psc-eran-meir
          
          echo "--- 4. Checking for Leaked Static IPs ---"
          gcloud compute addresses list --project=commit-gcp-psc-eran-meir
          
          echo "========================================"
          echo " If all lists above are empty, your project is safe!"